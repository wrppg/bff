name: Build - PackageManager

on:
  workflow_dispatch:

env:
  APP_NAME: "PackageManagerPro"
  APK_PATH_PREFIX: "app/build/outputs/apk/pro/release"
  NEW_APP_ID: 'bff.packagemanager'
  FLAV: "pro"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          repository: "SmartPack/PackageManager"
          ref: "master"

      - uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"
          cache: "gradle"

      - name: Change versionCode To Max INT
        run: >
          sed -E '/^\s*versionCode/s/[0-9]+$/2147483647/' -i app/build.gradle || \
          sed -E '/^\s*versionCode/s/[0-9]+$/2147483647/' -i app/build.gradle.kts
      
      - name: Change app and package name
        run: |
          BUILD_GRADLE=$(find app -maxdepth 1 -name 'build.gradle' -or -name 'build.gradle.kts')
          APP_ID=$(awk -F '"' '/applicationId / {print $2; exit}' $BUILD_GRADLE)
          sed -E "/applicationId /s|${APP_ID}|${NEW_APP_ID}|" -i $BUILD_GRADLE
          
          # sed -E '/applicationId /s|com\.smartpack\.packagemanager|bff.packagemanager|' -i app/build.gradle
          # sed -E '/app_name/s|LADB|LADB-|' -i app/src/main/res/values/strings.xml
      
      - name: Build release APK
        env:
          RELEASE_ANTIPIRACY: false
        run: |
          chmod +x ./gradlew
          ./gradlew :app:assemble${FLAV^}Release

      - name: List APKs
        run: find . -name '*.apk'

      - name: Sign APK
        env:
          KEYSTORE: ${{ secrets.SIGNING_KEY }}
          SIGNING_STORE_PASSWORD: ${{ secrets.SIGNING_STORE_PASSWORD }}
        run: |
          echo "${KEYSTORE}" | base64 -d > apksign.keystore
          versionName=$( jq -r '.elements[0].versionName' ${APK_PATH_PREFIX}/output-metadata.json )
          ${ANDROID_HOME}/build-tools/34.0.0/apksigner sign --ks apksign.keystore --ks-pass env:SIGNING_STORE_PASSWORD ${APK_PATH_PREFIX}/app-${FLAV:-""}${FLAV:+-}release-unsigned.apk

          # for apk in ${APK_PATH_PREFIX}/*.apk; do ${ANDROID_HOME}/build-tools/34.0.0/apksigner sign --ks apksign.keystore --ks-pass env:SIGNING_STORE_PASSWORD $apk; done

      - name: Release
        env:
          GH_TOKEN: ${{ secrets.GH_APK_REPO }}
          # GH_TOKEN: ${{ github.token }}
        run: |
          versionName=$( jq -r '.elements[0].versionName' ${APK_PATH_PREFIX}/output-metadata.json )
          mv ${APK_PATH_PREFIX}/app-${FLAV:-""}${FLAV:+-}release-unsigned.apk ${APK_PATH_PREFIX}/${APP_NAME}_${versionName}.apk
          gh release create "${versionName}-${APP_NAME}" --title "${APP_NAME} ${versionName}" --repo wrppg/apk ${APK_PATH_PREFIX}/*.apk
          # gh release upload "${versionName}-${APP_NAME}" ${APK_PATH_PREFIX}/*.apk
